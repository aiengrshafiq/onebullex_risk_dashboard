{% extends "base.html" %}

{% block title %}Risk Rules Manager{% endblock %}
{% block page_title %}Risk Rules Management{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center py-3 bg-transparent border-bottom-0">
        <h5 class="mb-0 text-white">Active Rules Engine</h5>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRuleModal">
            <i class="fas fa-plus me-2"></i>Add New Rule
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead>
                    <tr>
                        <th class="ps-4">Rule Name</th>
                        <th>Logic Expression</th>
                        <th class="text-center">Action</th>
                        <th class="text-center">Priority</th>
                        <th class="text-center">Status</th>
                        <th class="text-end pe-4">Controls</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rule in rules %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-white">{{ rule.rule_name }}</div>
                            <small class="text-muted">{{ rule.narrative }}</small>
                        </td>
                        <td style="width: 35%;">
                            <code class="text-info bg-dark px-2 py-1 rounded" style="font-size: 0.85em;">{{ rule.logic_expression }}</code>
                        </td>
                        <td class="text-center">
                            {% if rule.action == 'PASS' %}
                                <span class="badge bg-success-subtle text-success border border-success px-3">PASS</span>
                            {% elif rule.action == 'HOLD' %}
                                <span class="badge bg-warning-subtle text-warning border border-warning px-3">HOLD</span>
                            {% else %}
                                <span class="badge bg-danger-subtle text-danger border border-danger px-3">{{ rule.action }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center fw-bold">{{ rule.priority }}</td>
                        <td class="text-center">
                            <span class="badge rounded-pill text-bg-{{ 'success' if rule.status == 'ACTIVE' else 'secondary' }}">{{ rule.status }}</span>
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-light me-1"><i class="fas fa-eye"></i></button>
                            <!-- <button class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button> -->
                             <button class="btn btn-sm btn-outline-primary edit-rule-btn" 
                                data-id="{{ rule.rule_id }}"
                                data-name="{{ rule.rule_name }}"
                                data-logic="{{ rule.logic_expression }}"
                                data-action="{{ rule.action }}"
                                data-narrative="{{ rule.narrative }}"
                                data-priority="{{ rule.priority }}"
                                data-status="{{ rule.status }}"
                                title="Edit Rule">
                            <i class="fas fa-edit"></i>
                        </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addRuleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border border-secondary text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Define New Risk Rule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label text-secondary">Rule Name</label>
                            <input type="text" class="form-control bg-black text-white border-secondary" id="rule_name" required placeholder="e.g. Large Withdrawal New IP">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Priority</label>
                            <input type="number" class="form-control bg-black text-white border-secondary" id="priority" value="10">
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary">Logic Expression (Python Syntax)</label>
                            <textarea class="form-control bg-black text-info border-secondary" id="logic_expression" rows="2" style="font-family: monospace;" required placeholder="(amount > 5000) and (kyc_level < 2)"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Action</label>
                            <select class="form-select bg-black text-white border-secondary" id="action">
                                <option value="HOLD">HOLD</option>
                                <option value="PASS">PASS</option>
                                <option value="REJECT">REJECT</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Status</label>
                            <select class="form-select bg-black text-white border-secondary" id="status">
                                <option value="ACTIVE">ACTIVE</option>
                                <option value="INACTIVE">INACTIVE</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary">Narrative / Description</label>
                            <input type="text" class="form-control bg-black text-white border-secondary" id="narrative" required placeholder="Explanation for analysts...">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRuleBtn">Save Rule</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border border-secondary text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Modify Risk Rule <span id="edit_rule_id_display" class="text-muted small ms-2"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRuleForm">
                    <input type="hidden" id="edit_rule_id">
                    
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label text-secondary">Rule Name</label>
                            <input type="text" class="form-control bg-black text-white border-secondary" id="edit_rule_name" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Priority</label>
                            <input type="number" class="form-control bg-black text-white border-secondary" id="edit_priority">
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary">Logic Expression</label>
                            <textarea class="form-control bg-black text-info border-secondary" id="edit_logic_expression" rows="2" style="font-family: monospace;" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Action</label>
                            <select class="form-select bg-black text-white border-secondary" id="edit_action">
                                <option value="HOLD">HOLD</option>
                                <option value="PASS">PASS</option>
                                <option value="REJECT">REJECT</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Status</label>
                            <select class="form-select bg-black text-white border-secondary" id="edit_status">
                                <option value="ACTIVE">ACTIVE</option>
                                <option value="INACTIVE">INACTIVE</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary">Narrative</label>
                            <input type="text" class="form-control bg-black text-white border-secondary" id="edit_narrative" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateRuleBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // 1. Open Edit Modal and Populate Data
    $(".edit-rule-btn").click(function() {
        // Get data from button attributes
        const id = $(this).data("id");
        const name = $(this).data("name");
        const logic = $(this).data("logic");
        const action = $(this).data("action");
        const narrative = $(this).data("narrative");
        const priority = $(this).data("priority");
        const status = $(this).data("status");

        // Populate Modal Fields
        $("#edit_rule_id").val(id);
        $("#edit_rule_id_display").text("#" + id);
        $("#edit_rule_name").val(name);
        $("#edit_logic_expression").val(logic);
        $("#edit_action").val(action);
        $("#edit_narrative").val(narrative);
        $("#edit_priority").val(priority);
        $("#edit_status").val(status);

        // Show Modal
        $('#editRuleModal').modal('show');
    });

    // 2. Submit Update
    $("#updateRuleBtn").click(function() {
        const id = $("#edit_rule_id").val();
        
        const payload = {
            rule_name: $("#edit_rule_name").val(),
            logic_expression: $("#edit_logic_expression").val(),
            action: $("#edit_action").val(),
            narrative: $("#edit_narrative").val(),
            priority: parseInt($("#edit_priority").val()),
            status: $("#edit_status").val()
        };

        $.ajax({
            url: "/risk-rules/" + id,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function(response) {
                $('#editRuleModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                alert("Error updating rule: " + xhr.responseText);
            }
        });
    });
    
        $("#saveRuleBtn").click(function() {
            // 1. Gather Data
            const payload = {
                rule_name: $("#rule_name").val(),
                logic_expression: $("#logic_expression").val(),
                action: $("#action").val(),
                narrative: $("#narrative").val(),
                priority: parseInt($("#priority").val()),
                status: $("#status").val()
            };

            // 2. Validate (Simple check)
            if(!payload.rule_name || !payload.logic_expression) {
                alert("Please fill in required fields.");
                return;
            }

            // 3. Send AJAX Request
            $.ajax({
                url: "/risk-rules/add",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function(response) {
                    // Close modal and reload page to show new data
                    $('#addRuleModal').modal('hide');
                    location.reload(); 
                },
                error: function(xhr) {
                    alert("Error saving rule: " + xhr.responseText);
                }
            });
        });
    });
</script>
{% endblock %}