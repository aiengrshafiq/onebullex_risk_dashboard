{% extends "base.html" %}
{% block title %}Phalanx Console{% endblock %}
{% block page_title %}
    Executive Risk Overview 
    <span class="badge bg-danger ms-2" style="font-size: 0.6em; vertical-align: middle;">LAST 24 HOURS (UTC)</span>
{% endblock %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --neon-green: #00ff9d;
        --neon-red: #ff4d4d;
        --neon-blue: #00d2ff;
        --neon-purple: #a020f0;
        --card-bg: #111;
        --card-border: #333;
        --trend-up: #00ff9d;
        --trend-down: #ff4d4d;
    }
    
    .kpi-card {
        background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        position: relative;
        overflow: hidden;
    }
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
    .kpi-green::before { background-color: var(--neon-green); }
    .kpi-blue::before { background-color: var(--neon-blue); }
    .kpi-purple::before { background-color: var(--neon-purple); }
    .kpi-red::before { background-color: var(--neon-red); }

    .kpi-value { font-size: 1.8rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
    .kpi-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #888; display: flex; justify-content: space-between; align-items: center;}
    
    .trend-badge {
        font-size: 0.75rem; font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(255,255,255,0.1);
    }
    .trend-up { color: var(--trend-up); }
    .trend-down { color: var(--trend-down); }
    .trend-neutral { color: #888; }

    .chart-container {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 15px;
        height: 320px;
    }
    
    .intel-card { background: #151515; border: 1px solid #444; border-radius: 8px; }
    .table-dark-custom { --bs-table-bg: transparent; --bs-table-color: #ccc; --bs-table-border-color: #333; }
</style>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="kpi-card kpi-green">
            <div class="kpi-value">{{ kpi.value_secured }}</div>
            <div class="kpi-label">
                <span><i class="fas fa-coins me-2"></i>Volume Monitored</span>
                <span class="trend-badge {{ 'trend-up' if kpi.value_trend >= 0 else 'trend-down' }}">
                    <i class="fas fa-{{ 'arrow-up' if kpi.value_trend >= 0 else 'arrow-down' }}"></i> {{ kpi.value_trend | abs }}%
                </span>
            </div>
            <div class="text-muted small mt-1" style="font-size: 0.7em;">
                Processing <strong>{{ kpi.txn_count }}</strong> Transactions
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="kpi-card kpi-blue">
            <div class="kpi-value">{{ kpi.txn_count }}</div>
            <div class="kpi-label">
                <span><i class="fas fa-list-ol me-2"></i>Total Txns</span>
                <span class="trend-badge {{ 'trend-up' if kpi.txn_trend >= 0 else 'trend-down' }}">
                    <i class="fas fa-{{ 'arrow-up' if kpi.txn_trend >= 0 else 'arrow-down' }}"></i> {{ kpi.txn_trend | abs }}%
                </span>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="kpi-card kpi-purple">
            <div class="kpi-value">{{ kpi.pass_rate }}%</div>
            <div class="kpi-label">
                <span><i class="fas fa-check-circle me-2"></i>Pass Rate</span>
                <span class="trend-badge trend-neutral">
                    {{ '+' if kpi.pass_trend >= 0 else '' }}{{ kpi.pass_trend }}%
                </span>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="kpi-card kpi-red">
            <div class="kpi-value">{{ kpi.avg_rule_lat }}</div>
            <div class="kpi-label">
                <span><i class="fas fa-stopwatch me-2"></i>Rule Latency</span>
                <span class="badge bg-dark border border-secondary text-secondary">AI: {{ kpi.avg_ai_lat }}</span>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">
                Decision Trend (Last 24h vs Previous)
            </h6>
            <canvas id="decisionTrendChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Processing Speed Trend (ms)</h6>
            <canvas id="latencyTrendChart"></canvas>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Flow Volume (USD)</h6>
            <canvas id="volumeChart"></canvas>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">
                AI vs Rule Performance
                <span class="float-end badge bg-secondary bg-opacity-25 text-info" style="font-size:0.7em">Current 24h</span>
            </h6>
            <canvas id="sourceDistributionChart"></canvas>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Blocked Exposure by Country</h6>
            <canvas id="countryChart"></canvas>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-5">
        <div class="intel-card h-100 p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-white mb-0"><i class="fas fa-brain text-info me-2"></i>AI Insight of the Day</h5>
                {% if ai_insight %}
                <span class="badge bg-info text-dark">Confidence: {{ ai_insight.confidence }}</span>
                {% endif %}
            </div>
            
            {% if ai_insight %}
            <div class="p-3 rounded bg-black border border-secondary mb-3">
                <div class="row g-2">
                    <div class="col-6"><small class="text-muted">User ID</small><div class="text-white fw-bold">{{ ai_insight.user_code }}</div></div>
                    <div class="col-6"><small class="text-muted">Threat</small><div class="text-danger fw-bold">{{ ai_insight.primary_threat }}</div></div>
                </div>
            </div>
            <p class="text-light small fst-italic">"{{ ai_insight.narrative }}"</p>
            <div class="mt-3">
                <small class="text-muted text-uppercase">LLM Reasoning</small>
                <div class="text-secondary small mt-1" style="max-height: 80px; overflow-y: auto;">
                    {{ ai_insight.llm_reasoning }}
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                No high-confidence AI rejections in the last 24 hours.
            </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-7">
        <div class="card shadow-sm border-secondary h-100 bg-dark">
            <div class="card-header bg-transparent border-secondary text-white">
                <i class="fas fa-ban text-danger me-2"></i>Recent High-Value Blocks
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark-custom table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">Time (UTC)</th>
                                <th>User</th>
                                <th>Currency</th>
                                <th>Source</th>
                                <th class="text-end pe-4">Decision</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in recent_blocks %}
                            <tr>
                                <td class="ps-4 small text-muted">{{ log.time_str }}</td>
                                <td class="fw-bold text-light">{{ log.user_code }}</td>
                                <td class="text-info small">{{ log.currency }}</td>
                                <td class="small">
                                    {% if 'AI' in log.source_label %}
                                    <span class="text-info">{{ log.source_label }}</span>
                                    {% else %}
                                    <span class="text-light">{{ log.source_label }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <span class="badge bg-danger">{{ log.decision }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    Chart.defaults.color = '#777';
    Chart.defaults.borderColor = '#333';

    // 1. COMPARATIVE DECISION TREND (Total Curr vs Prev)
    new Chart(document.getElementById('decisionTrendChart'), {
        type: 'bar',
        data: {
            labels: {{ charts.decisions_trend.labels | tojson }},
            datasets: [
                {
                    label: 'Current 24h',
                    data: {{ charts.decisions_trend.current | tojson }},
                    backgroundColor: '#00ff9d', 
                    borderRadius: 4, barPercentage: 0.6
                },
                {
                    label: 'Previous 24h',
                    data: {{ charts.decisions_trend.previous | tojson }},
                    backgroundColor: '#444', 
                    borderRadius: 4, barPercentage: 0.6
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, grid: { color: '#222' } } },
            plugins: { legend: { labels: { color: '#ccc' } } }
        }
    });

    // 2. LATENCY (Line)
    new Chart(document.getElementById('latencyTrendChart'), {
        type: 'line',
        data: {
            labels: {{ charts.latency.labels | tojson }},
            datasets: [
                {
                    label: 'Rule Latency',
                    data: {{ charts.latency.rule | tojson }},
                    borderColor: '#a020f0', tension: 0.4
                },
                {
                    label: 'AI Latency',
                    data: {{ charts.latency.ai | tojson }},
                    borderColor: '#ff4d4d', tension: 0.4
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            elements: { point: { radius: 0 } },
            plugins: { tooltip: { mode: 'index', intersect: false } }
        }
    });

    // 3. VOLUME (Stacked Bar)
    new Chart(document.getElementById('volumeChart'), {
        type: 'bar',
        data: {
            labels: {{ charts.volume.labels | tojson }},
            datasets: [
                {
                    label: 'Blocked ($)',
                    data: {{ charts.volume.block | tojson }},
                    backgroundColor: '#ff4d4d'
                },
                {
                    label: 'Passed ($)',
                    data: {{ charts.volume.pass | tojson }},
                    backgroundColor: '#00ff9d'
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { stacked: true }, y: { stacked: true } }
        }
    });

    // 4. NEW: SOURCE DISTRIBUTION (Rule vs AI - Grouped Bar)
    new Chart(document.getElementById('sourceDistributionChart'), {
        type: 'bar',
        data: {
            labels: {{ charts.source_dist.labels | tojson }},
            datasets: [
                {
                    label: 'Rule Engine',
                    data: {{ charts.source_dist.rule | tojson }},
                    backgroundColor: '#a020f0', // Purple
                    borderRadius: 4
                },
                {
                    label: 'AI Agent',
                    data: {{ charts.source_dist.ai | tojson }},
                    backgroundColor: '#00d2ff', // Blue
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: true } }
        }
    });

    // 5. COUNTRY (Horizontal Bar)
    new Chart(document.getElementById('countryChart'), {
        type: 'bar',
        indexAxis: 'y',
        data: {
            labels: {{ charts.countries.labels | tojson }},
            datasets: [{
                label: 'Risk Volume ($)',
                data: {{ charts.countries.data | tojson }},
                backgroundColor: '#ff9e00',
                barThickness: 20
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}