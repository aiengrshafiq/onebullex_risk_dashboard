{% extends "base.html" %}
{% block title %}Phalanx Console{% endblock %}
{% block page_title %}
    Executive Risk Overview 
    <span class="badge bg-danger ms-2" style="font-size: 0.6em; vertical-align: middle;">LAST 24 HOURS (UTC)</span>
{% endblock %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --neon-green: #00ff9d;
        --neon-red: #ff4d4d;
        --neon-blue: #00d2ff;
        --neon-purple: #a020f0;
        --card-bg: #111;
        --card-border: #333;
    }
    
    .kpi-card {
        background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
    .kpi-green::before { background-color: var(--neon-green); }
    .kpi-red::before { background-color: var(--neon-red); }
    .kpi-blue::before { background-color: var(--neon-blue); }
    .kpi-purple::before { background-color: var(--neon-purple); }
    .kpi-value { font-size: 1.8rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
    .kpi-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #888; }
    
    .chart-container {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 15px;
        height: 320px;
    }
    
    .intel-card { background: #151515; border: 1px solid #444; border-radius: 8px; }
    
    .table-dark-custom { --bs-table-bg: transparent; --bs-table-color: #ccc; --bs-table-border-color: #333; }
</style>
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="kpi-card kpi-green" style="padding-right: 13px !important; padding-left: 13px !important;">
            <div class="kpi-value">{{ kpi.secured_usd }}</div>
            <div class="kpi-label d-flex align-items-center">
                <i class="fas fa-shield-alt me-2"></i>
                Value Secured
                <span class="badge bg-white text-dark ms-2 bg-opacity-75" style="font-size: 0.8em; font-weight: 800;">
                    {{ kpi.secured_count }} Txns
                </span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card kpi-blue">
            <div class="kpi-value">{{ kpi.pass_rate }}%</div>
            <div class="kpi-label"><i class="fas fa-bolt me-2"></i>Global Pass Rate</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card kpi-purple">
            <div class="kpi-value">{{ kpi.avg_rule_lat }}</div>
            <div class="kpi-label"><i class="fas fa-cogs me-2"></i>Rule Latency</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card kpi-red">
            <div class="kpi-value">{{ kpi.avg_ai_lat }}</div>
            <div class="kpi-label"><i class="fas fa-robot me-2"></i>AI Agent Latency</div>
        </div>
    </div>
</div>
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Decision Distribution (Rule vs AI)</h6>
            <canvas id="decisionMixChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Processing Speed Trend (ms)</h6>
            <canvas id="latencyTrendChart"></canvas>
        </div>
    </div>
</div>
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Flow Volume (USD)</h6>
            <canvas id="volumeChart"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Primary Threat Types</h6>
            <canvas id="threatChart"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="chart-container">
            <h6 class="text-white mb-3 small text-uppercase">Blocked Exposure by Country</h6>
            <canvas id="countryChart"></canvas>
        </div>
    </div>
</div>
<div class="row g-4">
    <div class="col-md-5">
        <div class="intel-card h-100 p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-white mb-0"><i class="fas fa-brain text-info me-2"></i>AI Insight of the Day</h5>
                {% if ai_insight %}
                <span class="badge bg-info text-dark">Confidence: {{ ai_insight.confidence }}</span>
                {% endif %}
            </div>
            
            {% if ai_insight %}
            <div class="p-3 rounded bg-black border border-secondary mb-3">
                <div class="row g-2">
                    <div class="col-6"><small class="text-muted">User ID</small><div class="text-white fw-bold">{{ ai_insight.user_code }}</div></div>
                    <div class="col-6"><small class="text-muted">Threat</small><div class="text-danger fw-bold">{{ ai_insight.primary_threat }}</div></div>
                </div>
            </div>
            <p class="text-light small fst-italic">"{{ ai_insight.narrative }}"</p>
            <div class="mt-3">
                <small class="text-muted text-uppercase">LLM Reasoning</small>
                <div class="text-secondary small mt-1" style="max-height: 80px; overflow-y: auto;">
                    {{ ai_insight.llm_reasoning }}
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                No high-confidence AI rejections in the last 24 hours.
            </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-7">
        <div class="card shadow-sm border-secondary h-100 bg-dark">
            <div class="card-header bg-transparent border-secondary text-white">
                <i class="fas fa-ban text-danger me-2"></i>Recent High-Value Blocks
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark-custom table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">Time (UTC)</th>
                                <th>User</th>
                                <th>Currency</th>
                                <th>Source</th>
                                <th class="text-end pe-4">Decision</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in recent_blocks %}
                            <tr>
                                <td class="ps-4 small text-muted">{{ log.time_str }}</td>
                                <td class="fw-bold text-light">{{ log.user_code }}</td>
                                <td class="text-info small">{{ log.currency }}</td>
                                <td class="small">
                                    {% if 'AI' in log.source_label %}
                                    <span class="text-info">{{ log.source_label }}</span>
                                    {% else %}
                                    <span class="text-light">{{ log.source_label }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <span class="badge bg-danger">{{ log.decision }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    Chart.defaults.color = '#777';
    Chart.defaults.borderColor = '#333';
    // 1. DECISION MIX CHART
    new Chart(document.getElementById('decisionMixChart'), {
        type: 'bar',
        data: {
            labels: ['PASS', 'HOLD', 'REJECT'],
            datasets: [
                {
                    label: 'Rule Engine',
                    data: {{ charts.decisions.rule | tojson }},
                    backgroundColor: '#a020f0',
                    borderRadius: 4
                },
                {
                    label: 'AI Agent',
                    data: {{ charts.decisions.ai | tojson }},
                    backgroundColor: '#00d2ff',
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
    // 2. LATENCY TREND CHART
    new Chart(document.getElementById('latencyTrendChart'), {
        type: 'line',
        data: {
            labels: {{ charts.latency.labels | tojson }},
            datasets: [
                {
                    label: 'Rule Latency',
                    data: {{ charts.latency.rule | tojson }},
                    borderColor: '#a020f0',
                    tension: 0.4
                },
                {
                    label: 'AI Latency',
                    data: {{ charts.latency.ai | tojson }},
                    borderColor: '#ff4d4d',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: { point: { radius: 0 } },
            plugins: { tooltip: { mode: 'index', intersect: false } }
        }
    });
    // 3. VOLUME CHART
    new Chart(document.getElementById('volumeChart'), {
        type: 'bar',
        data: {
            labels: {{ charts.volume.labels | tojson }},
            datasets: [
                {
                    label: 'Blocked ($)',
                    data: {{ charts.volume.block | tojson }},
                    backgroundColor: '#ff4d4d'
                },
                {
                    label: 'Passed ($)',
                    data: {{ charts.volume.pass | tojson }},
                    backgroundColor: '#00ff9d'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { stacked: true }, y: { stacked: true } }
        }
    });
    // 4. THREATS
    new Chart(document.getElementById('threatChart'), {
        type: 'doughnut',
        data: {
            labels: {{ charts.threats.labels | tojson }},
            datasets: [{
                data: {{ charts.threats.data | tojson }},
                backgroundColor: ['#ff4d4d', '#ff9e00', '#00d2ff', '#a020f0', '#ffffff'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    // 5. COUNTRY EXPOSURE (Renamed Chart)
    new Chart(document.getElementById('countryChart'), {
        type: 'bar',
        indexAxis: 'y',
        data: {
            labels: {{ charts.countries.labels | tojson }},
            datasets: [{
                label: 'Risk Volume ($)',
                data: {{ charts.countries.data | tojson }},
                backgroundColor: '#ff9e00',
                barThickness: 20
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}